---
machine:
  node:
    version: 4.6.2
  services:
    - docker
  environment:
    NODE_VERSION: 4.6.2
    METEOR_PRETTY_OUTPUT: 0
    METEOR_WAREHOUSE_URLBASE: https://d3fm2vapipm3k9.cloudfront.net

dependencies:
  override:
    - test -f $HOME/.meteor/meteor || (curl https://install.meteor.com | sh)
    - sudo ln -s $HOME/.meteor/meteor /usr/bin/meteor
  cache_directories:
    - ../.meteor

test:
  override:
    - ./admin/run_tests.sh:
        parallel: true

deployment:
  docker:
    branch: v2-flat
    commands:
      - ls -la $CIRCLE_ARTIFACTS
      - tail -n +1 $CIRCLE_ARTIFACTS/images*
      - export
      - docker images
      - docker ps -a
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
